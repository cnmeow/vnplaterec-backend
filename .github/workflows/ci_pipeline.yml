name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  tests:
    uses: ./.github/workflows/test.yml
    permissions:
      security-events: write

  analysis:
    needs: tests
    uses: ./.github/workflows/source_analysis.yml
    permissions:
      security-events: write

  dockertrivy:
    needs: analysis
    uses: ./.github/workflows/docker_trivy.yml
    permissions:
      security-events: write
      
  notify:
    name: Slack Notification
    needs: [tests, analysis, dockertrivy]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Notify Slack if Failure
        if: contains(needs.*.result, 'failure')
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_CHANNEL: general
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: danger
          SLACK_ICON: https://github.com/rtCamp.png?size=48
          SLACK_USERNAME: vnplaterec-backend
          SLACK_TITLE: ‚ùå CI Pipeline Failed
          SLACK_MESSAGE: |
            üö® *Workflow failed!*  
            ‚Ä¢ Repository: ${{ github.repository }}  
            ‚Ä¢ Branch: ${{ github.ref }}  
            ‚Ä¢ Commit: ${{ github.sha }}  
            ‚Ä¢ Triggered by: ${{ github.actor }}  
            ‚Ä¢ Job: ${{ github.job }}  
            ‚Ä¢ Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Notify Slack if Success
        if: ${{ !contains(needs.*.result, 'failure') }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_CHANNEL: general
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: good
          SLACK_ICON: https://github.com/rtCamp.png?size=48
          SLACK_USERNAME: vnplaterec-backend
          SLACK_TITLE: ‚úÖ CI Pipeline Success
          SLACK_MESSAGE: "All jobs passed successfully!"